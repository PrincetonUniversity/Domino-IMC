---
title: "WebRTC Cellular 11/30 Experiment: Overview"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
params:
  ue_data_file: "113023-ue.csv"
  sfu_data_file: "113023-sfu.csv"
  fig_path: "fig/"
---

```{R setup, include=FALSE}
source("../r/setup.R")

knitr::opts_chunk$set(dev=c("png", "pdf"), fig.width=9, fig.height=4.5,
  fig.align="center", fig.keep="high", fig.path=params$fig_path) 
```

```{r import}
pkts_ue <- read_csv(params$ue_data_file, col_types="") %>%
  mutate(
    encap = as.factor(encap),
    rtp_ssrc = as.factor(rtp_ssrc),
    rtp_pt = as.factor(rtp_pt),
    dir = as.factor(if_else(ip_src == "192.168.0.20", "tx", "rx"))
  ) %>%
  group_by(ip_src, ip_dst, udp_src, udp_dst)

pkts_ue$flow_id = as.factor(group_indices(pkts_ue))

pkts_sfu <- read_csv(params$sfu_data_file, col_types="") %>%
  mutate(
    encap = as.factor(encap),
    rtp_ssrc = as.factor(rtp_ssrc),
    rtp_pt = as.factor(rtp_pt),
    dir = as.factor(if_else(ip_src == "192.168.68.8", "tx", "rx"))
  ) %>%
  group_by(ip_src, ip_dst, udp_src, udp_dst)

pkts_sfu$flow_id = as.factor(group_indices(pkts_sfu))

pkts_sfu %<>% 
  ungroup() %>%
  filter(ts_s >= 1701379289) %>% 
  mutate(ts_s = ts_s - 1701379289) %>% 
  mutate(ts_ms = ts_s * 1e3 + ts_us / 1e3)

pkts_ue %<>%
  ungroup() %>%
  filter(ts_s >= 1701379289) %>%
  mutate(ts_s = ts_s - 1701379289) %>%
  mutate(ts_ms = ts_s * 1e3 + ts_us / 1e3)
```

```{r}
streams_ue <- pkts_ue %>%
  filter(rtp_ssrc != 1234) %>%
  group_by(ip_src, ip_dst,rtp_ssrc, rtp_pt) %>%
  summarize(n = n(), min_ts_ms = min(ts_ms), max_ts_ms = max(ts_ms), .groups = "drop") %>%
  mutate(
    dir = as.factor(if_else(ip_src == "192.168.0.20", "tx", "rx")))
    # dir = factor(dir, labels = c("Send", "Receive")))

streams_sfu <- pkts_sfu %>%
  filter(rtp_ssrc != 1234) %>%
  group_by(ip_src, ip_dst,rtp_ssrc, rtp_pt) %>%
  summarize(n = n(), min_ts_ms = min(ts_ms), max_ts_ms = max(ts_ms), .groups = "drop") %>%
  mutate(
    dir = as.factor(if_else(ip_src == "192.168.68.8", "tx", "rx")))
    # dir = factor(dir, labels = c("Send", "Receive")))
```

**Send RTP PTs:**

Video: VP8 at 90 kHz with Simulcast + RTX
* main PT = 96
* RTX PT = 97

Audio: Opus at 48 kHz with in-band FEC
* main PT = 111

**Receive RTP PTs:**

Video: VP8 at 90 kHz with RTX
* main PT  = 101 (?)
* RTX PT = 102 (?)
Audio: Opus at 48 kHz with in-band FEC
* main PT = 100 (?)

```{r ue-streams}
streams_ue %>%
  mutate(min_ts_s = min_ts_ms / 1e3, max_ts_s = max_ts_ms / 1e3) %>%
  ggplot(aes(x = min_ts_s, xend = max_ts_s, y = rtp_ssrc, yend = rtp_ssrc, color = rtp_pt)) +
    labs(title = "RTP Streams at UE", x = "Time [s]", y = "RTP SSRC", color = "RTP PT") +
    xlim(0, 820) +
    geom_segment(linewidth = 1.25) +
    theme_om() +
    theme(
      strip.background = element_rect(color="white", fill="white"),
      strip.text.x = element_text(size = 10, face = "bold")
    ) +
    facet_wrap(~dir)
```

* to filter for SSRCs that get forwarded or received to the UE, use:
`ue_ssrcs <- streams_ue$rtp_ssrc` and `filter(rtp_ssrc %in% ue_ssrcs)`

```{r sfu-streams}
streams_sfu %>%
  mutate(min_ts_s = min_ts_ms / 1e3, max_ts_s = max_ts_ms / 1e3) %>%
  ggplot(aes(x = min_ts_s, xend = max_ts_s, y = rtp_ssrc, yend = rtp_ssrc, color = rtp_pt)) +
    labs(title = "RTP Streams at SFU", x = "Time [s]", y = "RTP SSRC", color = "RTP PT") +
    xlim(0, 820) +
    geom_segment(linewidth = 1.25) +
    theme_om() +
    theme(
      strip.background = element_rect(color="white", fill="white"),
      strip.text.x = element_text(size = 10, face = "bold")
    ) +
    facet_wrap(~dir)
```

```{r}
pkts_ue %>%
  group_by(ip_src, ip_dst, udp_src, udp_dst) %>%
  summarize(n = n(), min_ts_ms = min(ts_ms), max_ts_ms = max(ts_ms)) %>%
  arrange(min_ts_ms)
```


```{r}
pkts_ue %>%
  mutate(ts_s = as.integer(ts_ms / 1000)) %>%
  group_by(ts_s) %>%
  summarize(dir = dir, flow_id = flow_id, pkts = n()) %>%
  ggplot(aes(x = ts_s, y = pkts, color = flow_id)) +
    geom_line() +
    facet_wrap(~dir,  ncol=1) +
    theme_om()

```

```{r}
pkts_ue %>%
  mutate(ts_s = as.integer(ts_ms / 1000)) %>%
  group_by(ts_s) %>%
  summarize(dir = dir, flow_id = flow_id, bytes = sum(frame_len) * 8 / 1000) %>%
  ggplot(aes(x = ts_s, y = bytes, color = flow_id)) +
    labs(x = "Time [s]", y = "Data Rate [KBit/s]") +
    geom_line() +
    facet_wrap(~dir,  ncol=1) +
    theme_om()
```



