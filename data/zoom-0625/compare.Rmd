---
title: "Zoom 06/25 - QoE Comparison"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
params:
  g5_experiment_name:   "zoom-0625-5g"
  tc_experiment_name:   "zoom-0625-tc"
  fig_path: fig/
---

```{R setup, include=FALSE}
source("../r/setup.R")

config <- list(
  "files" = list(
    "g5" = list(
      "ssim_file" = paste(params$g5_experiment_name, paste(params$g5_experiment_name, "ssim.csv", sep = "-"), sep = "/"),
      "receiver_frames_file" = paste(params$g5_experiment_name, paste(params$g5_experiment_name, "receiver-frames.csv", sep = "-"), sep = "/")
    ),
    "tc" = list(
      "ssim_file" = paste(params$tc_experiment_name, paste(params$tc_experiment_name, "ssim.csv", sep = "-"), sep = "/"),
      "receiver_frames_file" = paste(params$tc_experiment_name, paste(params$tc_experiment_name, "receiver-frames.csv", sep = "-"), sep = "/")
    )
  ),
  "single_color" = "dodgerblue4"
)
```


```{r import}
ssim <- list(
  "g5" = read_csv(config$files$g5$ssim_file, col_types="iiin", comment="#"),
  "tc" = read_csv(config$files$tc$ssim_file, col_types="iiin", comment="#")
)

frames <- list(
  "g5" = read_csv(config$files$g5$receiver_frames_file, col_types = "nciciiffnnnnniiiin"),
  "tc" = read_csv(config$files$tc$receiver_frames_file, col_types = "nciciiffnnnnniiiin")
)
```

```{r ssim-cdf, fig.height = 4, fig.width = 6}

bind_rows(
  ssim$g5 %>% select(ssim) %>%
    mutate(ssim = if_else(ssim == -1.0, NA, ssim), type = "5g") %>% filter(!is.na(ssim)),
  ssim$tc %>% select(ssim) %>%
    mutate(ssim = if_else(ssim == -1.0, NA, ssim), type = "tc") %>% filter(!is.na(ssim))
) %>% 
  ggplot(aes(x = ssim, color = type)) +
    labs(x = "SSIM", y = "CDF") +
    scale_color_brewer(
      name = "Experiment",
      palette = "Set1",
      breaks = c("5g", "tc"),
      labels = c("5G", "TC")) +
    stat_ecdf() +
    xlim(0.825,0.875) +
    theme_om() +
    theme(
      legend.position.inside = c(0.975,0.5)
    )
```
```{r}
bind_rows(
  frames$g5 %>% mutate(type = "5g"),
  
) 

frames$tc %>% mutate(type = "tc")%>% 
  filter(media_type == 16) %>%
  filter(pkts_seen == pkts_hint) %>%
  select(fps, min_ts_s) %>%
  ggplot(aes(x = min_ts_s, y = fps)) +
    geom_line()
  
  
```

```{r fps-cdf, fig.height = 4, fig.width = 6}

bind_rows(
  frames$g5 %>% mutate(type = "5g"),
  frames$tc %>% mutate(type = "tc") ,
) %>% filter(media_type == 16 & pkts_seen == pkts_hint) %>% 
  select(type, fps) %>%
  ggplot(aes(x = fps, color = type)) +
    labs(x = "Frame Rate [fps]", y = "CDF") +
    scale_color_brewer(
      name = "Experiment",
      palette = "Set1",
      breaks = c("5g", "tc"),
      labels = c("5G", "TC")) +
    stat_ecdf() +
    theme_om() +
    xlim(0,35) +
    theme(
      legend.position.inside = c(0.2,0.75)
)
```


```{r fps-cdf-paper, fig.height = 1.8, fig.width = 2.4}

bind_rows(
  frames$g5 %>% mutate(type = "5g"),
  frames$tc %>% mutate(type = "tc") ,
) %>% filter(media_type == 16 & pkts_seen == pkts_hint) %>% 
  ggplot(aes(x = fps, color = type)) +
    labs(x = "Frame Rate [fps]", y = "CDF") +
    scale_color_brewer(
      name = "Experiment",
      palette = "Set1",
      breaks = c("5g","tc"),
      labels = c("5G","Emulated")) +
    stat_ecdf() +
    theme_om() +
    xlim(0,35) +
    theme(
      legend.position.inside = c(0.5,0.76),
      legend.title = element_blank())
```


```{r ssim-cdf-paper, fig.height = 1.8, fig.width = 2.4}

bind_rows(
  ssim$g5 %>% select(ssim) %>%
    mutate(ssim = if_else(ssim == -1.0, NA, ssim), type = "5g") %>% filter(!is.na(ssim)),
  ssim$tc %>% select(ssim) %>%
    mutate(ssim = if_else(ssim == -1.0, NA, ssim), type = "tc") %>% filter(!is.na(ssim))
) %>% 
  ggplot(aes(x = ssim, color = type)) +
    labs(x = "SSIM", y = "CDF") +
    scale_color_brewer(
      name = "Experiment",
      palette = "Set1",
      breaks = c("5g", "tc"),
      labels = c("5G","Emulated")) +
    stat_ecdf() +
    xlim(0.775,0.9) +
    theme_om() +
    theme(
      legend.position.inside = c(0.5,0.76),
      legend.title = element_blank())
```

```{r jitter-cdf, fig.height = 4, fig.width = 6}

# bind_rows(
#   core_receiver_frames$g5_static %>% mutate(type = "5g_static"),
#   core_receiver_frames$g5_marginal %>% mutate(type = "5g_marginal"),
#   core_receiver_frames$g5_mobile %>% mutate(type = "5g_mobile"),
#   core_receiver_frames$tc_static %>% mutate(type = "tc_static"),
#   core_receiver_frames$tc_marginal %>% mutate(type = "tc_marginal"),
#   core_receiver_frames$tc_mobile %>% mutate(type = "tc_mobile")
# ) %>% filter(media_type == 16) %>% select(type, jitter_ms) %>%
#   ggplot(aes(x = jitter_ms, color = type)) +
#     labs(x = "Video Jitter [ms] (log.)", y = "CDF") +
#     scale_color_brewer(
#       name = "Experiment",
#       palette = "Set1",
#       breaks = c("5g_static", "5g_mobile", "5g_marginal", "tc_static", "tc_marginal", "tc_mobile"),
#       labels = c("5G/static", "5G/mobile", "5G/marginal", "TC/static", "TC/marginal", "TC/mobile")) +
#     scale_x_log10(expand = c(0.05, 0), limits = c(10,100), breaks = c(10, 100)) +
#     annotation_logticks(sides = "b", mid = unit(0.15, "cm"), long = unit(0.2, "cm"), color = "gray30") +
#     stat_ecdf() +
#     theme_om() +
#     # xlim(0,NA) +
#     theme(
#       legend.position.inside = c(0.2,0.7)
#     )
```

```{r jitter-cdf-paper, fig.height = 1.8, fig.width = 2.4}
bind_rows(
  frames$g5 %>% mutate(type = "5g"),
  frames$tc %>% mutate(type = "tc")
) %>% filter(media_type == 16) %>% select(type, jitter_ms) %>%
  ggplot(aes(x = jitter_ms, color = type)) +
    labs(x = "Video Jitter [ms] (log.)", y = "CDF") +
    scale_color_brewer(
      name = "Experiment",
      palette = "Set1",
      breaks = c("5g", "tc"),
      labels = c("5G", "Emulated")) +
    scale_x_log10(expand = c(0.06, 0), limits = c(10,100), breaks = c(10, 100)) +
    annotation_logticks(sides = "b", mid = unit(0.15, "cm"), long = unit(0.2, "cm"), color = "gray30") +
    stat_ecdf() +
    theme_om() +
    # xlim(0,NA) +
    theme(
      legend.position.inside = c(0.96,0.3),
      legend.title = element_blank())
```


```{r bitrate-cdf-paper, fig.height = 1.8, fig.width = 2.4}
bind_rows(
  frames$g5 %>% mutate(type = "g5"),
  frames$tc %>% mutate(type = "tc")
) %>% filter(tp_src == 8801) %>%
  group_by(type, min_ts_s) %>%
  summarize(bitrate = sum(frame_size) * 8 / 1000, .groups = "drop") %>%
  ggplot(aes(x = bitrate, color = type)) +
    labs(x = "Receive Bitrate [Kbps]", y = "CDF") +
    scale_x_continuous(expand = c(0.15,0)) +
    scale_color_brewer(
      name = "Experiment",
      palette = "Set1",
      breaks = c("g5", "tc"),
      labels = c("5G", "Emulated")) +
    # xlim(0,1500) +
    stat_ecdf() +
    theme_om() +
    theme(
      legend.position.inside = c(0.5,0.76),
      legend.title = element_blank())
```
