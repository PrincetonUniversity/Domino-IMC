---
title: "Zoom 06/25 5G - Frames"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
params:
  experiment_name: "zoom-0625-5g"
---

```{R setup, include=FALSE}
source("../../r/setup.R")
```

```{r import}
sender_frames <- read_csv(paste(params$experiment_name, "sender-frames.csv", sep = "-"), col_types = "nciciiffnnnnniiiin")
receiver_frames <- read_csv(paste(params$experiment_name, "core-frames.csv", sep = "-"), col_types = "nciciiffnnnnniiiin")
sender_frames %<>% mutate()
receiver_frames %<>% mutate(min_ts_ms = to_ms(min_ts_s, min_ts_us, min(sender_frames$min_ts_s)))
```

```{r}
frames <- bind_rows(
  sender_frames %>% mutate(side = as.factor("Sender")),
  receiver_frames %>% mutate(side = as.factor("Receiver"))) %>%
  mutate(
    min_ts_ms = to_ms(min_ts_s, min_ts_us, min(sender_frames$min_ts_s)),
    max_ts_ms = to_ms(max_ts_s, max_ts_us, min(sender_frames$min_ts_s)),
    max_ts_s  = as.integer(max_ts_ms / 1000) # for fps calculation
  )
```

```{r}
fps <- frames %>%
  filter(media_type == 16 & pkts_seen == pkts_hint) %>% # only video without FEC
  group_by(side, rtp_ext1, max_ts_s) %>%
  summarize(fps = n(), .groups = "drop")
```

```{r fps-by-layer, fig.height = 4, fig.width = 12}
fps %>%
  ggplot(aes(x = max_ts_s, y = fps, color = rtp_ext1)) +
    labs(title = "Frame Rate by Frame Type", x = "Time [s]", y = "Frame Rate [fps]", color = "SVC Frame Type") +
    geom_line() +
    facet_wrap(~side, nrow = 2) +
    theme_om() +
    theme(legend.position = "right")
```





```{r delay-spread-cdf, fig.height = 1.7, fig.width = 2.4}
frames %>% 
  filter(media_type != 0) %>%
  filter(pkts_seen == pkts_hint) %>%
  filter(media_type == 16) %>%
  filter(max_ts_ms < 200000) %>%
  mutate(delay_spread_ms = max_ts_ms - min_ts_ms) %>%
  # filter(delay_spread_ms < 50) %>%
  ggplot(aes(x = delay_spread_ms, color = side)) +
    labs(x = "Delay Spread [ms]", y = "CDF", color = "Location") +
    scale_color_brewer(
      name = "Location",
      palette = "Set1",
      breaks = c("Sender", "Receiver"),
      labels = c("Sender", "5G Core")) +
    # scale_x_log10() +
    xlim(0,35) +
    stat_ecdf() +
    theme_om() +
      theme(
      legend.position.inside = c(0.96,0.35))
  
```
